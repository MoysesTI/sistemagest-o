// ==========================================
// PRISMA SCHEMA - SISTEMA DE GESTÃO DE AULAS
// PrismaTech Code Academy - v2.0
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum UserRole {
  ADMIN // Pedagógico - acesso total
  PROFESSOR // Acesso restrito aos próprios dados
}

enum DiaSemana {
  SEGUNDA
  TERCA
  QUARTA
  QUINTA
  SEXTA
  SABADO
  DOMINGO
}

enum StatusTurma {
  PENDENTE
  ATIVA
  CONCLUIDA
  CANCELADA
}

enum TipoTarefa {
  PLANEJAMENTO // Planejamento de aula
  ORGANIZACAO // Organização de conteúdo
  PRODUCAO_MATERIAL // Produção de material
  EDICAO_VIDEO // Edição de vídeo
  PROJETO // Projeto especial
  REUNIAO // Reunião pedagógica
  OUTRO
}

enum StatusTarefa {
  PENDENTE
  EM_ANDAMENTO
  CONCLUIDA
  CANCELADA
}

// ==========================================
// USUÁRIOS (Admin Pedagógico e Professor)
// ==========================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  senha     String
  nome      String
  telefone  String?
  role      UserRole @default(PROFESSOR)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Dados MEI (para professores)
  cnpj           String?
  razaoSocial    String?
  certificadoMEI Boolean @default(false)

  // Relacionamentos
  turmas            Turma[]
  cronogramas       CronogramaItem[]
  tarefasExtras     TarefaExtra[]
  registrosHora     RegistroHora[]
  modulosLecionados ProfessorModulo[]

  // Módulos e aulas personalizados do professor
  modulosPersonalizados Modulo[] @relation("ProfessorModulos")
  aulasPersonalizadas   Aula[]   @relation("ProfessorAulas")

  @@map("users")
}

// ==========================================
// CURSOS, MÓDULOS E AULAS
// ==========================================

model Curso {
  id        String   @id @default(cuid())
  codigo    String   @unique
  nome      String
  descricao String?
  cor       String   @default("#2980b9")
  ativo     Boolean  @default(true)
  ordem     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Arquivo de referência do curso geral
  arquivoReferencia String?

  // Relacionamentos
  modulos Modulo[]
  turmas  Turma[]

  @@map("cursos")
}

model Modulo {
  id        String   @id @default(cuid())
  codigo    String
  nome      String
  descricao String?
  ordem     Int      @default(1)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Arquivo de referência do módulo
  arquivoReferencia String?

  // Professor dono (null = template original, preenchido = cópia personalizada)
  professorId String?
  professor   User?   @relation("ProfessorModulos", fields: [professorId], references: [id])

  // Relacionamentos
  cursoId         String
  curso           Curso             @relation(fields: [cursoId], references: [id], onDelete: Cascade)
  aulas           Aula[]
  professores     ProfessorModulo[]
  turmaModulos    TurmaModulo[]
  cronogramaItems CronogramaItem[] // Módulos ministrados no cronograma

  // Código único por curso + professor (permite mesmo código para professores diferentes)
  @@unique([cursoId, codigo, professorId])
  @@map("modulos")
}

model Aula {
  id        String   @id @default(cuid())
  numero    Int
  titulo    String
  descricao String?
  duracao   String   @default("2h30min")
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Arquivo/Link de referência da aula
  arquivoReferencia String?

  // Imagem do slide (preparado para futuro)
  imagemSlide String?

  // Tópicos da aula (array de strings)
  topicos String[]

  // Professor dono (null = template original, preenchido = cópia personalizada)
  professorId String?
  professor   User?   @relation("ProfessorAulas", fields: [professorId], references: [id])

  // Relacionamentos
  moduloId        String
  modulo          Modulo           @relation(fields: [moduloId], references: [id], onDelete: Cascade)
  cronogramaItems CronogramaItem[] // Aulas ministradas no cronograma

  // Número único por módulo + professor (permite mesmo número para professores diferentes)
  @@unique([moduloId, numero, professorId])
  @@map("aulas")
}

// Relacionamento Professor <-> Módulos que leciona
model ProfessorModulo {
  id          String   @id @default(cuid())
  professorId String
  professor   User     @relation(fields: [professorId], references: [id], onDelete: Cascade)
  moduloId    String
  modulo      Modulo   @relation(fields: [moduloId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([professorId, moduloId])
  @@map("professor_modulos")
}

// ==========================================
// TURMAS
// ==========================================

model Turma {
  id            String      @id @default(cuid())
  codigo        String      @unique
  nome          String
  local         String
  qtdAlunos     Int         @default(0)
  diasSemana    DiaSemana[]
  horarioInicio String
  horarioFim    String
  dataInicio    DateTime // Data de início do curso
  dataFim       DateTime // Data de término do curso
  aulaAtual     Int         @default(0)
  status        StatusTurma @default(PENDENTE)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relacionamentos
  professorId String
  professor   User   @relation(fields: [professorId], references: [id])
  cursoId     String
  curso       Curso  @relation(fields: [cursoId], references: [id])

  cronogramas   CronogramaItem[]
  registrosHora RegistroHora[]
  turmaModulos  TurmaModulo[]

  @@map("turmas")
}

// Módulos ativos na turma (progresso)
model TurmaModulo {
  id        String   @id @default(cuid())
  turmaId   String
  turma     Turma    @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  moduloId  String
  modulo    Modulo   @relation(fields: [moduloId], references: [id])
  aulaAtual Int      @default(0)
  concluido Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([turmaId, moduloId])
  @@map("turma_modulos")
}

// ==========================================
// CRONOGRAMA E TAREFAS
// ==========================================

model CronogramaItem {
  id             String    @id @default(cuid())
  data           DateTime
  horaInicio     String
  horaFim        String
  descricao      String?
  realizada      Boolean   @default(false) // CHECK do professor
  validadoAdmin  Boolean   @default(false) // CHECK do admin
  validadoPorId  String? // ID do admin que validou
  dataValidacao  DateTime? // Data/hora da validação
  duracaoMinutos Int? // Duração calculada
  valorCalculado Float? // Valor em R$
  bonusAplicado  Float? // Percentual de bônus (ex: 33)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Conteúdo ministrado (obrigatório para check)
  conteudoMinistrado String? // Descrição do que foi passado na aula

  // Referência ao módulo/aula do curso (opcional)
  moduloId String?
  modulo   Modulo? @relation(fields: [moduloId], references: [id])
  aulaId   String?
  aula     Aula?   @relation(fields: [aulaId], references: [id])

  // Relacionamentos
  professorId   String
  professor     User         @relation(fields: [professorId], references: [id])
  turmaId       String?
  turma         Turma?       @relation(fields: [turmaId], references: [id])
  tarefaExtraId String?
  tarefaExtra   TarefaExtra? @relation(fields: [tarefaExtraId], references: [id])

  @@map("cronograma_items")
}

model TarefaExtra {
  id             String       @id @default(cuid())
  tipo           TipoTarefa
  titulo         String
  descricao      String?
  data           DateTime
  horaInicio     String
  horaFim        String
  status         StatusTarefa @default(PENDENTE)
  validadoAdmin  Boolean      @default(false) // CHECK do admin
  validadoPorId  String? // ID do admin que validou
  dataValidacao  DateTime? // Data/hora da validação
  duracaoMinutos Int? // Duração calculada
  valorCalculado Float? // Valor em R$
  bonusAplicado  Float? // Percentual de bônus
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relacionamentos
  professorId String
  professor   User             @relation(fields: [professorId], references: [id])
  cronogramas CronogramaItem[]

  @@map("tarefas_extras")
}

// ==========================================
// REGISTRO DE HORAS E PAGAMENTOS
// ==========================================

model RegistroHora {
  id             String   @id @default(cuid())
  data           DateTime
  horaInicio     String
  horaFim        String
  duracaoMinutos Int
  tipo           String // "AULA" ou tipo de tarefa
  descricao      String?
  valorHora      Float
  valorTotal     Float
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relacionamentos
  professorId String
  professor   User    @relation(fields: [professorId], references: [id])
  turmaId     String?
  turma       Turma?  @relation(fields: [turmaId], references: [id])

  @@map("registros_hora")
}

// ==========================================
// PARÂMETROS DO SISTEMA
// ==========================================

model Parametro {
  id        String   @id @default(cuid())
  chave     String   @unique
  valor     String
  descricao String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("parametros")
}
